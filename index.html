<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipton - Maximum Implementation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1e3c72;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        h1 {
            font-size: 2.5em;
        }

        h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .video-slot {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-input {
            margin-bottom: 10px;
        }

        .file-input input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .video-preview {
            margin-bottom: 10px;
            display: none;
        }

        .video-preview video {
            width: 100%;
            max-height: 200px;
            background: #000;
            border-radius: 5px;
        }

        .video-info {
            font-size: 0.85em;
            color: #aaa;
            margin-bottom: 10px;
        }

        .name-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .name-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .magic-btn {
            padding: 10px 15px;
            background: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        .magic-btn:hover {
            background: #45a049;
        }

        .res-selector {
            padding: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .title-section, .subscribe-section, .generate-section, .quality-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .title-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .title-inputs input {
            padding: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .subscribe-section input, .quality-section input, .quality-section select {
            width: 100%;
            padding: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            margin-bottom: 10px;
        }

        #generateBtn, #downloadBtn, #cancelBtn, #resetBtn {
            padding: 15px 30px;
            background: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        #generateBtn:hover, #downloadBtn:hover, #resetBtn:hover {
            background: #45a049;
        }

        #cancelBtn {
            background: #f44336;
        }

        #cancelBtn:hover {
            background: #d32f2f;
        }

        #generateBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #progress {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        #progressBar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        #progressBar div {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        #progressText {
            text-align: center;
            font-weight: bold;
        }

        #message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: #4CAF50;
        }

        .message.error {
            background: #f44336;
        }

        .message.info {
            background: #2196F3;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ Clipton - Maximum Implementation</h1>
        </header>

        <div class="main-content">
            <!-- Video Upload Section -->
            <div class="upload-section">
                <h2>Videos</h2>
                
                <div class="video-slots">
                    <div class="video-slot">
                        <div class="slot-header">
                            <span>Video Rank #1</span>
                            <select class="res-selector" id="res1">
                                <option value="mobile">Mobile</option>
                                <option value="pc">PC</option>
                            </select>
                        </div>
                        <div class="file-input">
                            <input type="file" id="video1" accept="video/*">
                        </div>
                        <div class="video-preview" id="preview1">
                            <video controls></video>
                        </div>
                        <div class="video-info" id="info1"></div>
                        <div class="name-input-group">
                            <input type="text" id="name1" placeholder="Clip name">
                            <button class="magic-btn" data-video="1" title="Enhance name">‚ú®</button>
                        </div>
                        <div class="status" id="status1"></div>
                    </div>

                    <div class="video-slot">
                        <div class="slot-header">
                            <span>Video Rank #2</span>
                            <select class="res-selector" id="res2">
                                <option value="mobile">Mobile</option>
                                <option value="pc">PC</option>
                            </select>
                        </div>
                        <div class="file-input">
                            <input type="file" id="video2" accept="video/*">
                        </div>
                        <div class="video-preview" id="preview2">
                            <video controls></video>
                        </div>
                        <div class="video-info" id="info2"></div>
                        <div class="name-input-group">
                            <input type="text" id="name2" placeholder="Clip name">
                            <button class="magic-btn" data-video="2" title="Enhance name">‚ú®</button>
                        </div>
                        <div class="status" id="status2"></div>
                    </div>

                    <div class="video-slot">
                        <div class="slot-header">
                            <span>Video Rank #3</span>
                            <select class="res-selector" id="res3">
                                <option value="mobile">Mobile</option>
                                <option value="pc">PC</option>
                            </select>
                        </div>
                        <div class="file-input">
                            <input type="file" id="video3" accept="video/*">
                        </div>
                        <div class="video-preview" id="preview3">
                            <video controls></video>
                        </div>
                        <div class="video-info" id="info3"></div>
                        <div class="name-input-group">
                            <input type="text" id="name3" placeholder="Clip name">
                            <button class="magic-btn" data-video="3" title="Enhance name">‚ú®</button>
                        </div>
                        <div class="status" id="status3"></div>
                    </div>

                    <div class="video-slot">
                        <div class="slot-header">
                            <span>Video Rank #4</span>
                            <select class="res-selector" id="res4">
                                <option value="mobile">Mobile</option>
                                <option value="pc">PC</option>
                            </select>
                        </div>
                        <div class="file-input">
                            <input type="file" id="video4" accept="video/*">
                        </div>
                        <div class="video-preview" id="preview4">
                            <video controls></video>
                        </div>
                        <div class="video-info" id="info4"></div>
                        <div class="name-input-group">
                            <input type="text" id="name4" placeholder="Clip name">
                            <button class="magic-btn" data-video="4" title="Enhance name">‚ú®</button>
                        </div>
                        <div class="status" id="status4"></div>
                    </div>

                    <div class="video-slot">
                        <div class="slot-header">
                            <span>Video Rank #5</span>
                            <select class="res-selector" id="res5">
                                <option value="mobile">Mobile</option>
                                <option value="pc">PC</option>
                            </select>
                        </div>
                        <div class="file-input">
                            <input type="file" id="video5" accept="video/*">
                        </div>
                        <div class="video-preview" id="preview5">
                            <video controls></video>
                        </div>
                        <div class="video-info" id="info5"></div>
                        <div class="name-input-group">
                            <input type="text" id="name5" placeholder="Clip name">
                            <button class="magic-btn" data-video="5" title="Enhance name">‚ú®</button>
                        </div>
                        <div class="status" id="status5"></div>
                    </div>
                </div>
            </div>

            <!-- Quality Settings Section -->
            <div class="quality-section">
                <h2>Quality Settings</h2>
                <div class="title-inputs">
                    <select id="qualitySelect">
                        <option value="low">Low Quality (1 Mbps)</option>
                        <option value="medium" selected>Medium Quality (2.5 Mbps)</option>
                        <option value="high">High Quality (5 Mbps)</option>
                        <option value="ultra">Ultra Quality (10 Mbps)</option>
                    </select>
                    <select id="fpsSelect">
                        <option value="24">24 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="60">60 FPS</option>
                    </select>
                </div>
            </div>

            <!-- Title Section -->
            <div class="title-section">
                <h2>Title</h2>
                <div class="title-inputs">
                    <input type="text" id="titleText" placeholder="Title" value="Best">
                    <input type="text" id="top5Text" placeholder="TOP 5" value="TOP 5">
                    <input type="color" id="top5Color" value="#FF0000" title="TOP 5 Color">
                    <input type="text" id="rankingObject" placeholder="Ranking" value="Moments">
                    <input type="color" id="objectColor" value="#FFD700" title="Ranking Color">
                    <input type="text" id="endingText" placeholder="Ending" value="Ever">
                </div>
            </div>

            <!-- Subscribe Button Section -->
            <div class="subscribe-section">
                <h2>Subscribe Button</h2>
                <input type="text" id="subscribeText" placeholder="Subscribe text" value="Subscribe for more!">
            </div>

            <!-- Generate Section -->
            <div class="generate-section">
                <button id="generateBtn" disabled>üé¨ Generate Video</button>
                <button id="cancelBtn" style="display: none;">‚ùå Cancel Generation</button>
                <button id="resetBtn">üîÑ Reset All</button>
                <div id="progress" style="display: none;">
                    <div id="progressBar">
                        <div style="width: 0%"></div>
                    </div>
                    <div id="progressText">Processing...</div>
                </div>
                <button id="downloadBtn" style="display: none;">‚¨áÔ∏è Download Video</button>
            </div>

            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        const state = {
            videos: {},
            resolutions: {},
            names: {},
            processedVideos: new Set(),
            recordedBlob: null,
            isGenerating: false,
            shouldCancel: false
        };

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            console.log('Initializing Maximum Implementation...');
            
            // Setup file input listeners
            for (let i = 1; i <= 5; i++) {
                const videoInput = document.getElementById(`video${i}`);
                const resSelector = document.getElementById(`res${i}`);
                const magicBtn = document.querySelector(`[data-video="${i}"].magic-btn`);
                const nameInput = document.getElementById(`name${i}`);

                console.log(`Setting up video ${i}:`, {
                    videoInput: !!videoInput,
                    resSelector: !!resSelector,
                    magicBtn: !!magicBtn,
                    nameInput: !!nameInput
                });

                if (videoInput) {
                    videoInput.addEventListener('change', (e) => handleVideoUpload(e, i));
                }
                if (resSelector) {
                    resSelector.addEventListener('change', (e) => {
                        state.resolutions[i] = e.target.value;
                        console.log(`Resolution for video ${i} set to:`, e.target.value);
                    });
                }
                if (magicBtn) {
                    magicBtn.addEventListener('click', () => enhanceName(i));
                }
                if (nameInput) {
                    nameInput.addEventListener('input', (e) => {
                        state.names[i] = e.target.value;
                    });
                }
            }

            // Setup generate button
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateVideo);
                console.log('Generate button setup complete');
            }

            // Setup cancel button
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelGeneration);
            }

            // Setup reset button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetAll);
            }

            // Setup download button
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadVideo);
            }

            // Initialize default values
            initializeDefaults();
            console.log('App initialization complete');
        }

        function initializeDefaults() {
            for (let i = 1; i <= 5; i++) {
                const resSelector = document.getElementById(`res${i}`);
                if (resSelector) {
                    state.resolutions[i] = resSelector.value;
                }
                const nameInput = document.getElementById(`name${i}`);
                if (nameInput) {
                    state.names[i] = nameInput.value;
                }
            }
        }

        function enhanceName(videoNum) {
            const nameInput = document.getElementById(`name${videoNum}`);
            const magicBtn = document.querySelector(`[data-video="${videoNum}"].magic-btn`);
            
            if (!nameInput || !nameInput.value) {
                showMessage('Please enter a name first', 'error');
                return;
            }

            let enhanced = nameInput.value;
            if (!enhanced.includes('‚ú®')) {
                enhanced = `‚ú® ${enhanced} ‚ú®`;
            }
            
            nameInput.value = enhanced;
            state.names[videoNum] = enhanced;
            
            if (magicBtn) {
                magicBtn.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    magicBtn.style.transform = 'scale(1)';
                }, 300);
            }
            
            showMessage('Name enhanced! ‚ú®', 'success');
        }

        function handleVideoUpload(event, videoNum) {
            const file = event.target.files[0];
            const statusEl = document.getElementById(`status${videoNum}`);
            const previewEl = document.getElementById(`preview${videoNum}`);
            const infoEl = document.getElementById(`info${videoNum}`);
            
            if (!file) {
                console.log(`No file selected for video ${videoNum}`);
                return;
            }

            console.log(`Loading video ${videoNum}:`, file.name, file.type, file.size);
            
            try {
                showMessage(`Loading video ${videoNum}...`, 'info');
                if (statusEl) {
                    statusEl.textContent = '‚è≥ Loading...';
                    statusEl.style.background = '#2196F3';
                }

                const video = document.createElement('video');
                video.preload = 'metadata';
                video.src = URL.createObjectURL(file);

                // Show video preview
                if (previewEl) {
                    const previewVideo = previewEl.querySelector('video');
                    if (previewVideo) {
                        previewVideo.src = video.src;
                        previewEl.style.display = 'block';
                    }
                }

                const timeout = setTimeout(() => {
                    console.error(`Video ${videoNum} metadata loading timeout`);
                    if (statusEl) {
                        statusEl.textContent = '‚ùå Timeout';
                        statusEl.style.background = '#f44336';
                    }
                    showMessage(`Video ${videoNum} loading timeout`, 'error');
                    URL.revokeObjectURL(video.src);
                    if (previewEl) previewEl.style.display = 'none';
                }, 15000);

                video.onloadedmetadata = () => {
                    clearTimeout(timeout);
                    console.log(`Video ${videoNum} metadata loaded successfully`);
                    console.log(`Video dimensions: ${video.videoWidth}x${video.videoHeight}, duration: ${video.duration}s`);
                    
                    state.videos[videoNum] = video;
                    
                    // Show video info
                    if (infoEl) {
                        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        infoEl.textContent = `üìÅ ${file.name} | ${sizeMB} MB | ${video.videoWidth}x${video.videoHeight} | ${video.duration.toFixed(1)}s`;
                    }
                    
                    if (statusEl) {
                        statusEl.textContent = '‚úÖ Loaded';
                        statusEl.style.background = '#4CAF50';
                    }
                    showMessage(`Video ${videoNum} loaded!`, 'success');
                    checkReady();
                };

                video.onerror = (e) => {
                    clearTimeout(timeout);
                    console.error(`Video ${videoNum} error:`, e);
                    if (statusEl) {
                        statusEl.textContent = '‚ùå Failed';
                        statusEl.style.background = '#f44336';
                    }
                    showMessage(`Failed to load video ${videoNum}`, 'error');
                    URL.revokeObjectURL(video.src);
                    if (previewEl) previewEl.style.display = 'none';
                };

            } catch (error) {
                console.error('Error handling video upload:', error);
                if (statusEl) {
                    statusEl.textContent = '‚ùå Error';
                    statusEl.style.background = '#f44336';
                }
                showMessage(`Error loading video ${videoNum}: ${error.message}`, 'error');
            }
        }

        function checkReady() {
            const allLoaded = Object.keys(state.videos).length === 5;
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.disabled = !allLoaded;

            if (allLoaded) {
                showMessage('‚úÖ All videos loaded! Click Generate.', 'success');
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            if (msg) {
                msg.textContent = text;
                msg.className = `message ${type}`;
                console.log(`Message: ${text} (${type})`);
            }
        }

        function showProgress(percent, text) {
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progress) progress.style.display = 'block';
            if (progressBar) progressBar.firstElementChild.style.width = `${percent}%`;
            if (progressText) progressText.textContent = text;
            
            // Update page title with progress
            document.title = `${percent}% - Clipton`;
        }

        function hideProgress() {
            const progress = document.getElementById('progress');
            if (progress) progress.style.display = 'none';
            document.title = 'Clipton - Maximum Implementation';
        }

        function cancelGeneration() {
            if (state.isGenerating) {
                state.shouldCancel = true;
                showMessage('Cancelling generation...', 'info');
            }
        }

        function resetAll() {
            if (state.isGenerating) {
                showMessage('Cannot reset while generating', 'error');
                return;
            }

            // Reset state
            state.videos = {};
            state.resolutions = {};
            state.names = {};
            state.processedVideos = new Set();
            state.recordedBlob = null;
            state.isGenerating = false;
            state.shouldCancel = false;

            // Reset UI
            for (let i = 1; i <= 5; i++) {
                // Clear file inputs
                const fileInput = document.getElementById(`video${i}`);
                if (fileInput) fileInput.value = '';

                // Clear previews
                const previewEl = document.getElementById(`preview${i}`);
                if (previewEl) {
                    const previewVideo = previewEl.querySelector('video');
                    if (previewVideo) {
                        previewVideo.src = '';
                        previewEl.style.display = 'none';
                    }
                }

                // Clear info
                const infoEl = document.getElementById(`info${i}`);
                if (infoEl) infoEl.textContent = '';

                // Clear status
                const statusEl = document.getElementById(`status${i}`);
                if (statusEl) {
                    statusEl.textContent = '';
                    statusEl.style.background = '';
                }

                // Clear names
                const nameInput = document.getElementById(`name${i}`);
                if (nameInput) nameInput.value = '';

                // Reset resolutions
                const resSelector = document.getElementById(`res${i}`);
                if (resSelector) resSelector.value = 'mobile';
            }

            // Reset buttons
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.disabled = true;

            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) downloadBtn.style.display = 'none';

            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';

            // Hide progress
            hideProgress();

            // Clear message
            showMessage('All fields reset', 'info');

            // Reinitialize defaults
            initializeDefaults();
        }

        async function generateVideo() {
            if (state.isGenerating) {
                showMessage('Already generating...', 'error');
                return;
            }

            try {
                state.isGenerating = true;
                state.shouldCancel = false;
                console.log('Starting video generation...');
                console.log('Loaded videos:', Object.keys(state.videos));
                showMessage('Starting video generation...', 'info');

                // Get quality settings
                const qualitySelect = document.getElementById('qualitySelect');
                const fpsSelect = document.getElementById('fpsSelect');
                
                const qualitySettings = {
                    low: { bitrate: 1000000 },
                    medium: { bitrate: 2500000 },
                    high: { bitrate: 5000000 },
                    ultra: { bitrate: 10000000 }
                };
                
                const quality = qualitySelect.value || 'medium';
                const fps = parseInt(fpsSelect.value) || 30;
                const bitrate = qualitySettings[quality].bitrate;

                console.log(`Quality: ${quality}, FPS: ${fps}, Bitrate: ${bitrate}`);

                const titleText = document.getElementById('titleText').value || 'Best';
                const top5Text = document.getElementById('top5Text').value || 'TOP 5';
                const top5Color = document.getElementById('top5Color').value || '#FF0000';
                const rankingObject = document.getElementById('rankingObject').value || 'Moments';
                const objectColor = document.getElementById('objectColor').value || '#FFD700';
                const endingText = document.getElementById('endingText').value || 'Ever';
                const subscribeText = document.getElementById('subscribeText').value || 'Subscribe for more!';

                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 1920;
                const ctx = canvas.getContext('2d');

                const stream = canvas.captureStream(fps);
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm',
                    videoBitsPerSecond: bitrate
                });

                // Show cancel button
                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) cancelBtn.style.display = 'inline-block';

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    if (state.shouldCancel) {
                        showMessage('Generation cancelled', 'error');
                        hideProgress();
                        return;
                    }

                    const blob = new Blob(chunks, { type: 'video/webm' });
                    state.recordedBlob = blob;
                    
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.style.display = 'inline-block';
                    }
                    
                    // Hide cancel button
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    
                    hideProgress();
                    showMessage('‚úÖ Video generated successfully!', 'success');
                };

                mediaRecorder.start();
                showProgress(0, 'Initializing...');

                const videoOrder = [3, 4, 5, 2, 1];
                
                for (let i = 0; i < videoOrder.length; i++) {
                    if (state.shouldCancel) {
                        console.log('Generation cancelled by user');
                        mediaRecorder.stop();
                        break;
                    }

                    const videoNum = videoOrder[i];
                    const video = state.videos[videoNum];
                    
                    console.log(`Processing video ${videoNum} (index ${i})`);
                    
                    if (!video) {
                        console.error(`Video ${videoNum} not found in state.videos:`, Object.keys(state.videos));
                        showMessage(`Video ${videoNum} not loaded, skipping...`, 'error');
                        continue;
                    }
                    
                    showProgress(20 + (i * 15), `Processing video ${i + 1}/5...`);
                    
                    video.currentTime = 0;
                    video.muted = true;
                    
                    await video.play();
                    
                    state.processedVideos.add(videoNum);
                    
                    await new Promise((resolve) => {
                        let frameCount = 0;
                        const maxFrames = 10000;
                        
                        const renderFrame = () => {
                            if (state.shouldCancel) {
                                video.pause();
                                resolve();
                                return;
                            }

                            frameCount++;
                            
                            if (video.ended || video.paused || frameCount > maxFrames) {
                                resolve();
                                return;
                            }
                            
                            ctx.fillStyle = '#000';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            drawVideoFrame(ctx, video, canvas.width, canvas.height, videoNum);
                            drawOverlays(ctx, canvas.width, canvas.height, titleText, top5Text, top5Color, 
                                        rankingObject, objectColor, endingText, videoNum);
                            
                            requestAnimationFrame(renderFrame);
                        };
                        
                        renderFrame();
                    });
                    
                    video.pause();

                    // Show subscribe button between videos 5 and 2
                    if (videoNum === 5) {
                        console.log('Showing subscribe button...');
                        showProgress(60, 'Showing subscribe button...');
                        await showSubscribeButton(ctx, canvas.width, canvas.height, video, subscribeText, fps);
                    }
                }
                
                if (!state.shouldCancel) {
                    showProgress(95, 'Finalizing...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    mediaRecorder.stop();
                    showProgress(100, 'Complete!');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('‚ùå Error: ' + error.message, 'error');
                hideProgress();
                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) cancelBtn.style.display = 'none';
            } finally {
                state.isGenerating = false;
                state.shouldCancel = false;
            }
        }

        function drawVideoFrame(ctx, video, canvasWidth, canvasHeight, videoNum) {
            const resolution = state.resolutions[videoNum] || 'mobile';
            
            try {
                const videoAspect = video.videoWidth / video.videoHeight;
                const canvasAspect = canvasWidth / canvasHeight;
                
                let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                
                if (resolution === 'pc') {
                    const zoomFactor = 1.15;
                    
                    if (videoAspect > canvasAspect) {
                        drawHeight = canvasHeight * zoomFactor;
                        drawWidth = drawHeight * videoAspect;
                        offsetX = (canvasWidth - drawWidth) / 2;
                        offsetY = (canvasHeight - drawHeight) / 2;
                    } else {
                        drawWidth = canvasWidth * zoomFactor;
                        drawHeight = drawWidth / videoAspect;
                        offsetX = (canvasWidth - drawWidth) / 2;
                        offsetY = (canvasHeight - drawHeight) / 2;
                    }
                } else {
                    if (videoAspect > canvasAspect) {
                        drawHeight = canvasHeight;
                        drawWidth = canvasHeight * videoAspect;
                        offsetX = (canvasWidth - drawWidth) / 2;
                    } else {
                        drawWidth = canvasWidth;
                        drawHeight = canvasWidth / videoAspect;
                        offsetY = (canvasHeight - drawHeight) / 2;
                    }
                }
                
                ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);
            } catch (e) {
                console.warn('Failed to draw video frame:', e);
            }
        }

        async function showSubscribeButton(ctx, width, height, currentVideo, subscribeText, fps = 30) {
            const duration = 5000;
            const totalFrames = (duration / 1000) * fps;
            let currentFrame = 0;
            
            return new Promise((resolve) => {
                const renderSubscribeFrame = () => {
                    if (state.shouldCancel) {
                        resolve();
                        return;
                    }
                    
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, width, height);
                    
                    if (currentVideo) {
                        drawVideoFrame(ctx, currentVideo, width, height, 5);
                    }
                    
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, width, height);
                    
                    const buttonWidth = 500;
                    const buttonHeight = 120;
                    const buttonX = (width - buttonWidth) / 2;
                    const buttonY = (height - buttonHeight) / 2;
                    
                    const gradient = ctx.createLinearGradient(buttonX, buttonY, buttonX, buttonY + buttonHeight);
                    gradient.addColorStop(0, '#FF0000');
                    gradient.addColorStop(1, '#CC0000');
                    ctx.fillStyle = gradient;
                    
                    const radius = 20;
                    ctx.beginPath();
                    ctx.moveTo(buttonX + radius, buttonY);
                    ctx.lineTo(buttonX + buttonWidth - radius, buttonY);
                    ctx.quadraticCurveTo(buttonX + buttonWidth, buttonY, buttonX + buttonWidth, buttonY + radius);
                    ctx.lineTo(buttonX + buttonWidth, buttonY + buttonHeight - radius);
                    ctx.quadraticCurveTo(buttonX + buttonWidth, buttonY + buttonHeight, buttonX + buttonWidth - radius, buttonY + buttonHeight);
                    ctx.lineTo(buttonX + radius, buttonY + buttonHeight);
                    ctx.quadraticCurveTo(buttonX, buttonY + buttonHeight, buttonX, buttonY + buttonHeight - radius);
                    ctx.lineTo(buttonX, buttonY + radius);
                    ctx.quadraticCurveTo(buttonX, buttonY, buttonX + radius, buttonY);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 42px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(subscribeText.toUpperCase(), width / 2, height / 2);
                    
                    ctx.font = '36px Arial';
                    ctx.fillText('‚ú®', buttonX - 50, height / 2);
                    ctx.fillText('‚ú®', buttonX + buttonWidth + 50, height / 2);
                    
                    currentFrame++;
                    
                    if (currentFrame >= totalFrames) {
                        resolve();
                    } else {
                        requestAnimationFrame(renderSubscribeFrame);
                    }
                };
                
                renderSubscribeFrame();
            });
        }

        function drawOverlays(ctx, width, height, titleText, top5Text, top5Color, rankingObject, objectColor, endingText, currentVideo) {
            const titleFontSize = Math.floor(width * 0.055);
            const numberFontSize = Math.floor(width * 0.09);
            const nameFontSize = Math.floor(width * 0.045);
            
            ctx.font = `bold ${titleFontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = Math.max(Math.floor(titleFontSize * 0.12), 4);
            
            const titleY = height * 0.06;
            
            const titleWidth = ctx.measureText(titleText).width;
            const top5Width = ctx.measureText(top5Text).width;
            const objectWidth = ctx.measureText(rankingObject).width;
            const endingWidth = ctx.measureText(endingText).width;
            const totalWidth = titleWidth + top5Width + objectWidth + endingWidth + 30;
            
            let x = (width - totalWidth) / 2;
            
            ctx.fillStyle = '#FFF';
            ctx.strokeText(titleText, x + titleWidth / 2, titleY);
            ctx.fillText(titleText, x + titleWidth / 2, titleY);
            x += titleWidth + 10;
            
            ctx.fillStyle = top5Color;
            ctx.strokeText(top5Text, x + top5Width / 2, titleY);
            ctx.fillText(top5Text, x + top5Width / 2, titleY);
            x += top5Width + 10;
            
            ctx.fillStyle = objectColor;
            ctx.strokeText(rankingObject, x + objectWidth / 2, titleY);
            ctx.fillText(rankingObject, x + objectWidth / 2, titleY);
            x += objectWidth + 10;
            
            ctx.fillStyle = '#FFF';
            ctx.strokeText(endingText, x + endingWidth / 2, titleY);
            ctx.fillText(endingText, x + endingWidth / 2, titleY);
            
            ctx.font = `bold ${numberFontSize}px Arial`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            let numberY = height * 0.18;
            const numberX = width * 0.05;
            const nameX = width * 0.18;
            const numberSpacing = height * 0.12;
            
            const numberColors = {
                1: '#FFD700',
                2: '#C0C0C0',
                3: '#CD7F32',
                4: '#FFFFFF',
                5: '#FFFFFF'
            };
            
            for (let i = 1; i <= 5; i++) {
                const numberText = `${i}.`;
                
                ctx.fillStyle = numberColors[i];
                ctx.strokeText(numberText, numberX, numberY);
                ctx.fillText(numberText, numberX, numberY);
                
                if (state.processedVideos.has(i) && state.names[i] && i === currentVideo) {
                    ctx.font = `bold ${nameFontSize}px Arial`;
                    ctx.fillStyle = '#FFF';
                    ctx.strokeText(state.names[i], nameX, numberY + 5);
                    ctx.fillText(state.names[i], nameX, numberY + 5);
                    ctx.font = `bold ${numberFontSize}px Arial`;
                }
                
                numberY += numberSpacing;
            }
        }

        function downloadVideo() {
            if (!state.recordedBlob) {
                showMessage('‚ùå Generate video first!', 'error');
                return;
            }
            
            try {
                showMessage('Preparing download...', 'info');
                
                const url = URL.createObjectURL(state.recordedBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = getFilename();
                a.style.display = 'none';
                
                document.body.appendChild(a);
                
                setTimeout(() => {
                    a.click();
                    
                    setTimeout(() => {
                        if (document.body.contains(a)) {
                            document.body.removeChild(a);
                        }
                        URL.revokeObjectURL(url);
                        showMessage('‚úÖ Downloaded!', 'success');
                    }, 100);
                }, 100);
                
            } catch (error) {
                console.error('Download error:', error);
                showMessage('‚ùå Download failed: ' + error.message, 'error');
            }
        }

        function getFilename() {
            const titleText = document.getElementById('titleText').value || 'Best';
            const top5Text = document.getElementById('top5Text').value || 'TOP 5';
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            return `${titleText} ${top5Text} - ${timestamp}.webm`;
        }
    </script>
</body>
</html>